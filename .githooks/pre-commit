#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook: scan staged changes for likely secrets.
# Skips commented added lines and diff headers.

diff_output=$(git diff --cached -U0 || true)
if [[ -z "${diff_output}" ]]; then
  exit 0
fi

# Only added lines, exclude diff headers and comments
added=$(printf "%s\n" "$diff_output" | grep -E '^\+[^+]' | grep -Ev '^\+\s*(#|//)' || true)

patterns=(
  'SNOWSQL_PWD'
  'SNOWFLAKE_PASSWORD'
  '[Pp]assword\s*='
  'AWS_SECRET_ACCESS_KEY'
  'AZURE_STORAGE_CONNECTION_STRING'
  'GCP_SERVICE_ACCOUNT_KEY'
  '-----BEGIN [A-Z0-9 ]*PRIVATE KEY-----'
  'BEGIN RSA PRIVATE KEY'
  'BEGIN EC PRIVATE KEY'
  'PRIVATE_KEY_PASSPHRASE'
  'PRIVATE_KEY_PATH'
  '[Pp]assphrase\s*='
)

matches=""
for pat in "${patterns[@]}"; do
  m=$(printf "%s\n" "$added" | grep -E "${pat}" || true)
  if [[ -n "$m" ]]; then
    matches+="$m"$'\n'
  fi
done

if [[ -n "$matches" ]]; then
  echo "ERROR: Potential secret detected in staged changes. Commit aborted." >&2
  echo "Matched lines (sanitized):" >&2
  printf "%s" "$matches" | sed -E 's/(=).*/\1***REDACTED***/' >&2
  echo "Refer to SECURITY.md and use config/.env.snowflake.example for sanitized templates." >&2
  exit 1
fi

exit 0

